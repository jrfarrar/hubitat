# Power Cycle Monitor v2.0 - Production Release

## Overview
Advanced Hubitat application that monitors power cycling patterns to detect when devices are left on. Provides detailed analytics on cycle timing and automatically triggers alerts when suspicious cycling patterns are detected.

## Features

### Core Functionality
- **Automatic Cycle Detection**: Monitors power meter readings to detect ON/OFF cycling patterns
- **Smart Alerts**: Triggers an alert switch when device cycles repeatedly (indicating it was left on)
- **Configurable Thresholds**: Customizable wattage, cycle count, and time window settings
- **Auto-Reset**: Automatically resets when device is truly turned off

### Advanced Analytics
- **Real-Time Statistics**: Displays current cycle count and averages
- **Session Tracking**: Records total runtime and cycle statistics for each session
- **Historical Data**: Maintains last session statistics for reference
- **Detailed Logging**: Comprehensive logging of all state changes and calculations

### User Interface Enhancements
- **Live Status Display**: Shows current monitoring status with color-coded indicators
  - ðŸŸ¢ Green: Normal monitoring
  - ðŸŸ¡ Orange: Cycles detected (building toward alert)
  - ðŸ”´ Red: Alert active (device left on)
- **Current Statistics Section**: Real-time display of:
  - Alert status and timestamp
  - Cycles detected vs. threshold
  - Average ON/OFF times
  - Last session summary
- **Manual Reset Button**: Instantly clear all statistics and alerts
- **Smart App Labels**: Dynamic labels show status at a glance

### Robustness
- **Input Validation**: Range checking on all user inputs
- **Error Handling**: Graceful handling of device communication errors
- **Null-Safe Operations**: Protected against upgrade scenarios and edge cases
- **BigDecimal Safety**: Proper handling of Groovy's decimal arithmetic
- **Sanity Checks**: Filters out erroneous power readings

## Installation

1. **Install Parent App** (if not already installed):
   - Install "Admin tools" parent app in Hubitat

2. **Install Child App**:
   - Go to Apps Code
   - Click "New App"
   - Paste the entire code
   - Click "Save"

3. **Create Instance**:
   - Go to Apps
   - Click "Add User App"
   - Select "Admin tools"
   - Click "Power Cycle Monitor Child"

## Configuration

### Required Settings

**Devices**
- **Power Meter to Monitor**: Select the power meter device tracking your appliance
- **Alert Switch**: Select a virtual or physical switch to activate when cycling is detected

**Cycle Detection Settings**
- **Watt Threshold** (default: 100W)
  - Power above this value = device ON
  - Power below this value = device OFF
  - Range: 1-10,000W
  
- **Number of Cycles** (default: 3)
  - How many ON/OFF cycles indicate "left on"
  - Range: 2-20 cycles
  
- **Time Window** (default: 30 minutes)
  - Cycles must occur within this window to trigger alert
  - Range: 5-180 minutes
  
- **Off Timeout** (default: 60 minutes)
  - Minutes with no cycling before considering device "truly off"
  - Range: 5-480 minutes

### Optional Settings

**Restrictions**
- **Restriction Switch**: Only run monitoring when this switch is ON
- **Mode Restrictions**: Do NOT run in selected modes (e.g., "Away", "Night")

**Logging**
- **None**: No logging
- **Running**: Info-level logging (recommended)
- **NeedHelp**: Debug-level logging (for troubleshooting)

## How It Works

### Detection Algorithm

1. **Power Monitoring**: Continuously monitors power meter readings
2. **State Detection**: Determines if device is ON (above threshold) or OFF (below threshold)
3. **Cycle Recording**: Records timestamp each time device turns ON
4. **Duration Tracking**: Calculates and stores ON duration and OFF duration for each cycle
5. **Pattern Evaluation**: Checks if enough cycles occurred within the time window
6. **Alert Trigger**: When threshold is reached, activates alert switch
7. **Auto-Reset**: After no activity for the off timeout period, resets everything

### Example Scenario: Water Softener

**Settings:**
- Watt Threshold: 100W
- Cycles to Detect: 3
- Time Window: 30 minutes
- Off Timeout: 60 minutes

**Timeline:**
```
06:50 - Device turns ON (1155W) â†’ 1st cycle
        OFF duration: N/A (first cycle)
06:51 - Device turns OFF (0W)
        ON duration: 30 seconds
06:54 - Device turns ON (1147W) â†’ 2nd cycle
        OFF duration: 2.5 minutes
06:54 - Device turns OFF (0W)
        ON duration: 28 seconds
06:55 - Device turns ON (1160W) â†’ 3rd cycle
        OFF duration: 2.2 minutes
        âš ï¸ ALERT TRIGGERED!
        Alert switch turned ON
        Avg ON: 27 seconds
        Avg OFF: 2.3 minutes

... device continues cycling ...

07:05 - Device turns OFF (0W)
        Final ON duration: 31 seconds

[No activity for 60 minutes]

08:05 - Device detected as truly OFF
        Alert switch turned OFF
        Session Stats logged:
          - Total runtime: 10 minutes
          - Total cycles: 5
          - Avg ON: 27 seconds
          - Avg OFF: 2 minutes
```

## App Label Status Indicators

The app label dynamically updates to show current status:

- **Monitoring (Green)**: `Power Cycle Monitor (Monitoring)`
- **Cycles Building (Orange)**: `Power Cycle Monitor (2/3 cycles - 1 more needed)`
- **Alert Active (Red)**: `Power Cycle Monitor (ALERT: 5 cycles - ON:27s/OFF:2.3min)`
- **With History (Green)**: `Power Cycle Monitor (Last: 10m (ON:27s/OFF:2min))`

## Current Statistics Display

When cycles are active or historical data exists, a "CURRENT STATUS" section appears showing:

- **Status Indicator**: Color-coded emoji and description
- **Alert Timestamp**: When alert was triggered (if active)
- **Cycle Progress**: Current cycles vs. threshold
- **Current Averages**: Real-time ON/OFF duration averages
- **Last Session**: Previous runtime and averages
- **Reset Button**: Clear all statistics

## Use Cases

### Appliances That Cycle
- **Water softeners**: Regeneration cycles
- **Well pumps**: Multiple pump cycles
- **Sump pumps**: Repeated activation
- **HVAC systems**: Frequent short-cycling
- **Water heaters**: Rapid heating cycles

### Detection Benefits
- **Energy waste**: Identify devices left on unnecessarily
- **Equipment issues**: Detect abnormal cycling patterns
- **Maintenance needs**: Unusual patterns may indicate problems
- **Usage analytics**: Understand device operation patterns

## Troubleshooting

### Alert Not Triggering

**Check:**
- Power meter is reporting values correctly
- Watt threshold is set appropriately (device ON > threshold > device OFF)
- Enough cycles are occurring within the time window
- Restrictions aren't preventing monitoring
- Log level is set to "Running" to see activity

### Incorrect Duration Calculations

**Verify:**
- App was updated to v2.0 (fixes BigDecimal issues)
- Statistics were reset after upgrade (use Reset button)
- Device actually cycles (not stuck ON or OFF)

### Alert Switch Not Activating

**Check:**
- Alert switch device is functioning
- Check Hubitat logs for errors
- Verify switch is not controlled by other apps
- Try a different virtual switch

## Logging Examples

### Normal Operation (Info Level)
```
Power Cycle Monitor: Device turned ON (1155W)
Power Cycle Monitor: Cycle recorded. Total cycles in last 30 minutes: 1
Power Cycle Monitor: Device turned OFF (0W)
Power Cycle Monitor: Device turned ON (1147W)
Power Cycle Monitor: Cycle recorded. Total cycles in last 30 minutes: 2
```

### Alert Trigger (Info Level)
```
Power Cycle Monitor: ALERT: Device has cycled 3 times in 30 minutes! Device appears to be LEFT ON.
Power Cycle Monitor: Cycle Stats - Avg ON time: 27 seconds, Avg OFF time: 2.3 minutes
Power Cycle Monitor: Alert switch turned ON
```

### Session End (Info Level)
```
Power Cycle Monitor: Checking device status - 60.0 minutes since last activity
Power Cycle Monitor: No activity detected for 60.0 minutes. Device appears to be truly OFF. Total runtime: 10.0 minutes
Power Cycle Monitor: Session Stats - Avg ON: 27 seconds, Avg OFF: 2 minutes, Total cycles: 5
Power Cycle Monitor: Alert switch turned OFF
```

### Debug Level
```
Power Cycle Monitor: Power: 1155W from Drilled Well Power Meter
Power Cycle Monitor: OFF duration: 2.35 minutes
Power Cycle Monitor: Cycle recorded. Total cycles in last 30 minutes: 2
Power Cycle Monitor: Power: 0W from Drilled Well Power Meter
Power Cycle Monitor: ON duration: 0.47 minutes
```

## Version History

### v2.0 - 2025-11-14 (Production Release)
- âœ… Fixed BigDecimal rounding issues (Math.round, String.format)
- âœ… Fixed null pointer exceptions on upgrade (null-safe initialization)
- âœ… Fixed OFF duration including idle time (proper state reset)
- âœ… Added current statistics display section
- âœ… Added manual reset capability
- âœ… Enhanced error handling and validation
- âœ… Improved logging with context
- âœ… Added input ranges and validation
- âœ… Dynamic status indicators
- âœ… Better UI organization

### v1.1 - 2025-11-12
- Added cycle timing tracking
- Average ON/OFF duration calculations
- Enhanced app label with timing info

### v1.0 - 2025-11-08
- Initial release
- Basic cycle detection
- Alert triggering
- Auto-reset functionality

## Credits

**Author**: J.R. Farrar  
**License**: Personal/Non-commercial use  
**Support**: [GitHub Issues or Hubitat Community Forum]

## FAQ

**Q: What's the difference between "left on" and actually being on?**  
A: "Left on" means the device is cycling repeatedly (ON/OFF/ON/OFF), which indicates it's actively running when it shouldn't be. A device that's truly "on" stays on continuously without cycling.

**Q: Can I monitor multiple devices?**  
A: Yes! Create a separate instance of the app for each device you want to monitor.

**Q: Does this work with energy meters or just power meters?**  
A: It requires a device with the "powerMeter" capability that reports current wattage. Most energy monitors also report power.

**Q: Why does it need a time window?**  
A: The time window prevents false alerts from cycles spread across a long period. For example, a device that cycles once per hour isn't "left on" - it's normal operation.

**Q: Can I use this to detect if someone leaves a light on?**  
A: Not really - lights don't cycle. This is specifically for devices that naturally turn on and off repeatedly (pumps, appliances, HVAC, etc.).

**Q: What happens if I change settings while monitoring?**  
A: The app will reset and start fresh with the new settings. Use the "Done" button to save changes.

## Advanced Tips

### Fine-Tuning Sensitivity

**More Sensitive** (detect earlier):
- Reduce cycle count (e.g., 2 instead of 3)
- Increase time window (e.g., 60 instead of 30 minutes)

**Less Sensitive** (avoid false alerts):
- Increase cycle count (e.g., 5 instead of 3)
- Decrease time window (e.g., 15 instead of 30 minutes)

### Integration Ideas

- **Notifications**: Use the alert switch to trigger notifications
- **Dashboard**: Add alert switch to dashboard for quick status
- **Automation**: Turn off device breaker when alert triggers (if safe to do so)
- **Logging**: Connect alert switch to data logging apps
- **Voice Alerts**: Use TTS to announce when device is left on

### Best Practices

1. **Test First**: Run for a few cycles to confirm settings work
2. **Check Logs**: Enable "Running" log level during initial setup
3. **Adjust Gradually**: Make small changes to thresholds
4. **Document Settings**: Note what works for each device
5. **Use Virtual Switches**: Safer than controlling real switches
6. **Reset After Changes**: Use reset button after modifying settings

---

**Ready to deploy!** This production version includes all bug fixes, enhancements, and polish for reliable operation.
